<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="perfil.css">
    <link rel="stylesheet" href="cabecalho.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
</head>
<body>
    
    <header id="header-placeholder"></header>

    <main>
        <div class="profile-container">
            <div class="profile-header">
                <div class="profile-picture-container">
                    <img src="https://placehold.co/150x150" alt="Foto de Perfil" class="profile-picture" id="profileImage">
                    <label for="fileUpload" class="edit-photo-label hidden">
                        <i class="fa-solid fa-camera"></i>
                    </label>
                </div>
                <input type="file" id="fileUpload" accept="image/*" class="hidden">

                <h2 class="profile-name" id="displayName">Nome Placeholder</h2>
            </div>
            <div class="profile-details">
                <h3>Detalhes do Perfil</h3>
                <p><strong>Email:</strong> <span id="displayEmail">email@placeholder.com</span></p>
                
                <div id="student-profile-fields" style="display: none;">
                    <p><strong>Matrícula:</strong> <span id="displayMatricula"></span></p>
                    <p><strong>Curso:</strong> <span id="displayCurso"></span></p>
                </div>
                
                <p><strong>Departamento:</strong> <span id="displayRole"></span></p>
                <p><strong>Desde:</strong> <span id="displayDesde">ANO</span></p>
            </div>
            <div class="profile-actions">
                <button class="btn-primary" id="editButton">Editar Perfil</button>
            </div>
        </div>
    </main>

    <script src="script.js"></script>

    <script>
        const editButton = document.querySelector('#editButton');
        const displayName = document.querySelector('#displayName');
        const profileImage = document.querySelector('#profileImage');
        const fileUpload = document.querySelector('#fileUpload');
        const editPhotoLabel = document.querySelector('.edit-photo-label');
        const profileContainer = document.querySelector('.profile-container');

        let isEditing = false;
        let inputElement = null;

        if(editButton && displayName && profileImage && fileUpload && editPhotoLabel && profileContainer) {
            
            editButton.addEventListener('click', async function() {
                
                if (isEditing === false) {
                    profileContainer.classList.add('edit-mode-active');
                    const nomeAtual = displayName.textContent;
                    
                    inputElement = document.createElement('input');
                    inputElement.type = 'text';
                    inputElement.value = nomeAtual;
                    inputElement.className = 'edit-input-name';

                    displayName.style.display = 'none';
                    displayName.parentNode.insertBefore(inputElement, displayName.nextSibling);
                    inputElement.focus();
                    
                    editButton.textContent = 'Salvar';
                    isEditing = true;

                } else {
                    
                    const novoNome = inputElement.value.trim();
                    const fotoFile = fileUpload.files[0];
                    const userId = localStorage.getItem('userId');

                    if (!userId) {
                        alert('Erro: ID do usuário não encontrado. Faça login novamente.');
                        return;
                    }

                    if (novoNome === "") {
                        alert("O nome não pode ficar em branco.");
                        inputElement.focus();
                        return;
                    }

                    const formData = new FormData();
                    formData.append('nome', novoNome);
                    
                    if (fotoFile) {
                        formData.append('foto', fotoFile);
                    }

                    try {
                        const url = `https://projetodevweb.onrender.com/atualizar-perfil/${userId}/`;
                        
                        const response = await fetch(url, {
                            method: 'POST',
                            body: formData,
                        });

                        if (!response.ok) {
                            throw new Error('Falha na resposta do servidor. Status: ' + response.status);
                        }

                        const result = await response.json(); 

                        if (result.status === 'sucesso') {
                            displayName.textContent = result.nome;
                            
                            if(result.fotoUrl) {
                                profileImage.src = result.fotoUrl;
                            }
                            
                            localStorage.setItem('nomeUsuario', result.nome);
                            localStorage.setItem('fotoUrlUsuario', result.fotoUrl);
                            
                            alert('Perfil atualizado com sucesso!');

                            profileContainer.classList.remove('edit-mode-active');
                            displayName.style.display = 'block';
                            if(inputElement) inputElement.remove();
                            editButton.textContent = 'Editar Perfil';
                            isEditing = false;
                            fileUpload.value = null;

                        } else {
                            alert('Erro ao salvar: ' + result.mensagem);
                        }

                    } catch (error) {
                        console.error('Erro ao enviar o formulário:', error);
                        alert('Erro de conexão. Não foi possível salvar as alterações.');
                    }
                }
            });

            fileUpload.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        profileImage.src = e.target.result;
                    }
                    reader.readAsDataURL(this.files[0]);
                }
            });

        } else {
            console.error("Um ou mais elementos para edição do perfil não foram encontrados.");
        }
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            function formatarRole(role) {
                if (role === 'admin') return 'Administrador';
                if (role === 'assistente') return 'Assistente';
                if (role === 'aluno') return 'Aluno';
                return role || 'Não informado';
            }

            function formatarCurso(cursoKey) {
                const cursos = {
                    'ads': 'Análise e Desenv. de Sistemas',
                    'computacao': 'Ciências da Computação',
                    'engenharia': 'Engenharia de Software',
                    'redes': 'Redes de Computadores'
                };
                return cursos[cursoKey] || cursoKey || 'Não informado';
            }

            const nomeCompleto = localStorage.getItem('nomeUsuario');
            const email = localStorage.getItem('emailUsuario');
            const dataCadastroStr = localStorage.getItem('dataCadastroUsuario');
            const userRole = localStorage.getItem('roleUsuario');
            const fotoUrl = localStorage.getItem('fotoUrlUsuario');
            const matricula = localStorage.getItem('matriculaUsuario');
            const curso = localStorage.getItem('cursoUsuario');

            const displayNameElement = document.getElementById('displayName');
            const displayEmailElement = document.getElementById('displayEmail');
            const displayDesdeElement = document.getElementById('displayDesde');
            const editButtonElement = document.getElementById('editButton');
            const profileImageElement = document.getElementById('profileImage');
            const displayRoleElement = document.getElementById('displayRole');

            if (nomeCompleto && displayNameElement) {
                const nomes = nomeCompleto.split(' ');
                const doisPrimeirosNomes = nomes.slice(0, 2).join(' ');
                displayNameElement.textContent = doisPrimeirosNomes;
            } else if (displayNameElement) {
                 displayNameElement.textContent = 'Usuário';
            }
            
            if (fotoUrl && fotoUrl !== 'null' && fotoUrl !== 'undefined' && profileImageElement) {
                profileImageElement.src = fotoUrl;
            }

            if (email && displayEmailElement) {
                displayEmailElement.textContent = email;
            } else if (displayEmailElement) {
                 displayEmailElement.textContent = 'Não informado';
            }
            
            if (displayRoleElement) {
                displayRoleElement.textContent = formatarRole(userRole);
            }

            if (userRole === 'aluno') {
                const studentFieldsDiv = document.getElementById('student-profile-fields');
                const displayMatriculaElement = document.getElementById('displayMatricula');
                const displayCursoElement = document.getElementById('displayCurso');
                
                if (studentFieldsDiv && displayMatriculaElement && displayCursoElement) {
                    displayMatriculaElement.textContent = matricula || 'Não informada';
                    displayCursoElement.textContent = formatarCurso(curso);
                    studentFieldsDiv.style.display = 'block';
                }
            }

            if (dataCadastroStr && displayDesdeElement) {
                try {
                    const dataCadastro = new Date(dataCadastroStr);
                    const anoCadastro = dataCadastro.getFullYear();
                    if (!isNaN(anoCadastro)) {
                        displayDesdeElement.textContent = anoCadastro;
                    } else {
                         displayDesdeElement.textContent = 'N/A';
                    }
                } catch (e) {
                    console.error('Erro ao processar data de cadastro:', e);
                    displayDesdeElement.textContent = 'N/A';
                }
            } else if (displayDesdeElement) {
                 displayDesdeElement.textContent = 'N/A';
            }
        });
    </script>
</body>
</html>