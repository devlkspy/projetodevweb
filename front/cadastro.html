<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Novo Aluno</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 640 640'%3E%3Cpath fill='%2374C0FC' d='M128 160C128 124.7 156.7 96 192 96L544 96C579.3 96 608 124.7 608 160L608 400L512 400L512 384C512 366.3 497.7 352 480 352L416 352C398.3 352 384 366.3 384 384L384 400L254.9 400C265.8 381.2 272 359.3 272 336C272 265.3 214.7 208 144 208C138.6 208 133.2 208.3 128 209L128 160zM333 512C327.9 487.8 316.7 465.9 300.9 448L608 448C608 483.3 579.3 512 544 512L333 512zM64 336C64 291.8 99.8 256 144 256C188.2 256 224 291.8 224 336C224 380.2 188.2 416 144 416C99.8 416 64 380.2 64 336zM0 544C0 491 43 448 96 448L192 448C245 448 288 491 288 544C288 561.7 273.7 576 256 576L32 576C14.3 576 0 561.7 0 544z'/%3E%3C/svg%3E">
    <link rel="stylesheet" href="cabecalho.css">
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="cadastro.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
</head>
<body>
    
    <header id="header-placeholder"></header>

    <main>
        <div class="form-container">
            <div class="form-header">
                <h2>Área de cadastro</h2>
                <p>Preencha os dados abaixo para registrar um aluno/administrador no sistema.</p>
            </div>
            <form class="registration-form" id="cadastro-form">
                <div class="form-group">
                    <label for="fullName">Nome Completo</label>
                    <input type="text" id="fullName" placeholder="Digite o nome completo" required>
                </div>
                <div class="form-group">
                    <label>Tipo de Usuário</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="role-aluno" name="role" value="aluno" checked>
                            <label for="role-aluno">Aluno</label>
                        </div>
                        <div class="radio-option" id="admin-radio-option">
                            <input type="radio" id="role-admin" name="role" value="admin">
                            <label for="role-admin">Administrador</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="role-assistant" name="role" value="assistente">
                            <label for="role-assistant">Assistente</label>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="birthDate">Data de Nascimento</label>
                        <input type="date" id="birthDate" required>
                    </div>
                    <div class="form-group">
                        <label for="cpf">CPF</label>
                        <input type="text" id="cpf" placeholder="000.000.000-00" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="generatedPassword">Senha Padrão (Primeiro Acesso)</label>
                    <div class="matricula-field-container">
                        <input type="text" id="generatedPassword" placeholder="Preencha o CPF e clique em Gerar..." readonly required>
                        <button type="button" id="generatePasswordBtn" class="btn-secondary">Gerar Senha</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="exemplo@email.com" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="phone">Telefone</label>
                        <input type="tel" id="phone" placeholder="(00) 00000-0000" required>
                    </div>
                </div>
                
                <div id="student-fields">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="matricula">Matrícula</label>
                            <div class="matricula-field-container">
                                <input type="text" id="matricula" placeholder="Preencha o CPF e clique em Gerar..." readonly required>
                                <button type="button" id="generateMatriculaBtn" class="btn-secondary">Gerar</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="shift">Turno</label>
                            <select id="shift" required>
                                <option value="" disabled selected>Selecione um turno</option>
                                <option value="manha">Manhã</option>
                                <option value="tarde">Tarde</option>
                                <option value="noite">Noite</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="course">Curso</label>
                            <select id="course" required>
                                <option value="" disabled selected>Selecione um curso</option>
                                <option value="ads">Análise e Desenvolvimento de Sistemas</option>
                                <option value="computacao">Ciências da Computação</option>
                                <option value="engenharia">Engenharia de Software</option>
                                <option value="redes">Redes de Computadores</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                         <div class="form-group">
                            <label>Modalidade</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="presencial" name="modality" value="presencial" checked>
                                    <label for="presencial">Presencial</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="ead" name="modality" value="ead">
                                    <label for="ead">EAD</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">Cadastrar</button>
                    <button type="reset" class="btn-secondary">Limpar</button>
                </div>
            </form>
        </div>
    </main>

    <script src="script.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const generatePasswordBtn = document.getElementById('generatePasswordBtn');
    const cpfField = document.getElementById('cpf');
    const passwordField = document.getElementById('generatedPassword');
    const cadastroForm = document.getElementById('cadastro-form');
    const userTypeRadios = document.querySelectorAll('input[name="role"]');
    const studentFieldsDiv = document.getElementById('student-fields');

    const phoneField = document.getElementById('phone');
    const birthDateField = document.getElementById('birthDate');

    if(cpfField) {
        cpfField.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);
            
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})\.(\d{3})(\d)/, '$1.$2.$3');
            value = value.replace(/(\d{3})\.(\d{3})\.(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
            e.target.value = value;
        });
    }
    
    if(phoneField) {
        phoneField.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);

            if (value.length > 10) {
                value = value.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
            } else if (value.length > 6) {
                value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/^(\d{2})(\d{0,5}).*/, '($1) $2');
            } else if (value.length > 0) {
                value = value.replace(/^(\d{0,2}).*/, '($1');
            }
            e.target.value = value;
        });
    }

    if (generatePasswordBtn && cpfField && passwordField) {
        generatePasswordBtn.addEventListener('click', function() {
            const cpfValue = cpfField.value.replace(/\D/g, '');

            if (cpfValue.length < 6) {
                alert('Por favor, preencha o CPF primeiro (pelo menos 6 dígitos).');
                cpfField.focus();
                return;
            }
            
            const anoAtual = new Date().getFullYear();
            const parteDoCpf = cpfValue.substring(0, 6);
            const senhaGerada = `${anoAtual}${parteDoCpf}`;
            
            passwordField.value = senhaGerada;
        });
    } else {
         console.error('Erro: Elementos para gerar senha não encontrados!');
    }


    if (cadastroForm) {
        cadastroForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const nomeInput = document.getElementById('fullName');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('generatedPassword');
            const roleInput = document.querySelector('input[name="role"]:checked');
            const birthDateInput = document.getElementById('birthDate');
            const cpfValue = document.getElementById('cpf').value.replace(/\D/g, '');

            if (cpfValue.length !== 11) {
                alert('O CPF deve conter 11 dígitos.');
                document.getElementById('cpf').focus();
                return;
            }
            
            const emailValue = emailInput.value;
            const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;

            if (!emailRegex.test(emailValue)) {
                alert('Formato de e-mail inválido. Verifique o email digitado (ex: usuario@dominio.com).');
                emailInput.focus();
                return;
            }

            if (birthDateInput) {
                const birthDateValue = new Date(birthDateInput.value);
                const today = new Date();
                
                const minAgeDate = new Date(today.getFullYear() - 15, today.getMonth(), today.getDate());
                const maxAgeDate = new Date(today.getFullYear() - 110, today.getMonth(), today.getDate());

                if (!birthDateInput.value || birthDateValue > minAgeDate) {
                    alert('Data de nascimento inválida. O usuário deve ter pelo menos 15 anos.');
                    birthDateInput.focus();
                    return;
                }

                if (birthDateValue < maxAgeDate) {
                    alert('Data de nascimento inválida. A idade máxima permitida é 110 anos.');
                    birthDateInput.focus();
                    return;
                }
            }

            if (!nomeInput || !emailInput || !passwordInput || !roleInput) {
                console.error('Erro: Não foi possível encontrar os campos nome, email, senha ou role.');
                alert('Erro interno ao encontrar campos do formulário.');
                return;
            }

            const nome = nomeInput.value;
            const email = emailInput.value;
            const senha = passwordInput.value;
            const role = roleInput.value;

             if (!senha) {
                 alert('Por favor, gere uma senha padrão antes de cadastrar.');
                 return;
             }
             
            const dados = {
                nome: nome,
                email: email,
                senha: senha,
                role: role
            };

            if (role === 'aluno') {
                const matriculaInput = document.getElementById('matricula');
                const courseInput = document.getElementById('course');
                const shiftInput = document.getElementById('shift');
                const modalityInput = document.querySelector('input[name="modality"]:checked');

                if (!matriculaInput || !courseInput || !shiftInput || !modalityInput) {
                     alert('Erro: Campos de aluno não encontrados.');
                     return;
                }
                
                if (!matriculaInput.value) {
                    alert('Por favor, gere a matrícula do aluno.');
                    return;
                }
                if (!courseInput.value) {
                    alert('Por favor, selecione o curso do aluno.');
                    return;
                }
                 if (!shiftInput.value) {
                    alert('Por favor, selecione o turno do aluno.');
                    return;
                }

                dados.matricula = matriculaInput.value;
                dados.curso = courseInput.value;
                dados.turno = shiftInput.value;
                dados.modalidade = modalityInput.value;
            }

            try {
                const response = await fetch('https://projetodevweb.onrender.com/cadastrar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });

                const resultado = await response.json();
                alert(resultado.mensagem);

                if (response.status === 201) {
                    cadastroForm.reset();
                    toggleStudentFields();
                }

            } catch (error) {
                 console.error('Erro na requisição fetch:', error);
                alert('Ocorreu um erro ao conectar ao servidor.');
            }
        });
    } else {
         console.error('Erro: Formulário com id="cadastro-form" não encontrado!');
    }


    function toggleStudentFields() {
         const isAdminChecked = document.getElementById('role-admin').checked;
         const isAssistantChecked = document.getElementById('role-assistant').checked;
        
     if (studentFieldsDiv) {
         const fields = studentFieldsDiv.querySelectorAll('input, select');
         if (isAdminChecked || isAssistantChecked) {
             studentFieldsDiv.style.display = 'none';
             fields.forEach(field => {
                 field.disabled = true;
                 field.required = false; 
             });
         } else {
             studentFieldsDiv.style.display = 'block';
             fields.forEach(field => {
                 field.disabled = false;
                 field.required = true;
             });
             
             document.getElementById('matricula').required = true;
             document.getElementById('shift').required = true;
             document.getElementById('course').required = true;
         }
     }
    }

    if (userTypeRadios.length > 0 && studentFieldsDiv) {
        userTypeRadios.forEach(radio => {
            radio.addEventListener('change', toggleStudentFields);
        });
        toggleStudentFields();
    } else {
         console.warn('Aviso: Elementos para esconder/mostrar campos de aluno não encontrados.');
    }

    const userRoleCheck = localStorage.getItem('roleUsuario');
    if (userRoleCheck === 'aluno') {
        alert('Acesso negado. Alunos não podem cadastrar novos usuários.');
        window.location.href = 'perfil.html';
    }
    
    if (userRoleCheck === 'assistente') {
        const adminOptionDiv = document.getElementById('admin-radio-option');
        if (adminOptionDiv) {
            adminOptionDiv.style.display = 'none';
        }
    }

    const generateMatriculaBtn = document.getElementById('generateMatriculaBtn');
    const matriculaField = document.getElementById('matricula');

    if (generateMatriculaBtn && cpfField && matriculaField) {
        generateMatriculaBtn.addEventListener('click', function() {
            const cpfValue = cpfField.value.replace(/\D/g, '');

            if (cpfValue.length < 6) {
                alert('Por favor, preencha o CPF primeiro (pelo menos 6 dígitos).');
                cpfField.focus();
                return;
            }
            
            const anoAtual = new Date().getFullYear();
            const parteDoCpf = cpfValue.substring(0, 6);
            const matriculaGerada = `${anoAtual}-${parteDoCpf}`;
            
            matriculaField.value = matriculaGerada;
        });
    } else {
        console.error('Erro: Elementos para gerar matrícula não encontrados!');
    }
});
</script>
    
</body>
</html>