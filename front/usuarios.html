<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Usuários</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 640 640'%3E%3Cpath fill='%2374C0FC' d='M128 160C128 124.7 156.7 96 192 96L544 96C579.3 96 608 124.7 608 160L608 400L512 400L512 384C512 366.3 497.7 352 480 352L416 352C398.3 352 384 366.3 384 384L384 400L254.9 400C265.8 381.2 272 359.3 272 336C272 265.3 214.7 208 144 208C138.6 208 133.2 208.3 128 209L128 160zM333 512C327.9 487.8 316.7 465.9 300.9 448L608 448C608 483.3 579.3 512 544 512L333 512zM64 336C64 291.8 99.8 256 144 256C188.2 256 224 291.8 224 336C224 380.2 188.2 416 144 416C99.8 416 64 380.2 64 336zM0 544C0 491 43 448 96 448L192 448C245 448 288 491 288 544C288 561.7 273.7 576 256 576L32 576C14.3 576 0 561.7 0 544z'/%3E%3C/svg%3E">
    <link rel="stylesheet" href="cabecalho.css">
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="usuarios.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
</head>
<body>

    <header id="header-placeholder"></header>

    <main>
        <div class="user-container">
            <div class="user-header">
                <h2>Gerenciamento de Usuários</h2>
                <p>Visualize e exclua usuários cadastrados no sistema.</p>
            </div>
            
            <div class="user-list-container">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Tipo</th>
                            <th>Curso (Matrícula)</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </main>
    
    <div id="loading-spinner" class="spinner-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const userRoleCheck = localStorage.getItem('roleUsuario');
            if (userRoleCheck === 'aluno' || userRoleCheck === 'assistente') {
                alert('Acesso negado. Você não tem permissão para ver esta página.');
                window.location.href = '/perfil';
                return;
            }

            const tableBody = document.getElementById('user-table-body');
            const spinner = document.getElementById('loading-spinner');
            const backendUrl = 'https://projetodevweb-production.up.railway.app';

            function formatarRole(role) {
                if (role === 'admin') return 'Administrador';
                if (role === 'assistente') return 'Assistente';
                if (role === 'aluno') return 'Aluno';
                return role;
            }

            function formatarCurso(cursoKey) {
                const cursos = {
                    'ads': 'Análise e Desenv. de Sistemas',
                    'computacao': 'Ciências da Computação',
                    'engenharia': 'Engenharia de Software',
                    'redes': 'Redes de Computadores'
                };
                return cursos[cursoKey] || cursoKey;
            }

            async function carregarUsuarios() {
                spinner.style.display = 'flex';
                try {
                    const response = await fetch(`${backendUrl}/usuarios`);
                    if (!response.ok) {
                        throw new Error('Falha ao buscar usuários: ' + response.status);
                    }
                    const usuarios = await response.json();
                    
                    tableBody.innerHTML = '';

                    if (usuarios.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Nenhum usuário cadastrado.</td></tr>';
                    }

                    usuarios.forEach(user => {
                        const tr = document.createElement('tr');
                        tr.setAttribute('data-user-id', user._id);
                        
                        let cursoMatricula = 'N/A';
                        if (user.role === 'aluno' && user.curso && user.matricula) {
                            cursoMatricula = `${formatarCurso(user.curso)} (${user.matricula})`;
                        }

                        tr.innerHTML = `
                            <td>${user.nome}</td>
                            <td>${user.email}</td>
                            <td>${formatarRole(user.role)}</td>
                            <td>${cursoMatricula}</td>
                            <td>
                                <button class="btn-delete" data-id="${user._id}">
                                    <i class="fa-solid fa-trash-can"></i> Excluir
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });

                    adicionarListenersExclusao();

                } catch (error) {
                    console.error('Erro ao carregar usuários:', error);
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: red;">Erro ao carregar usuários.</td></tr>';
                } finally {
                    spinner.style.display = 'none';
                }
            }

            function adicionarListenersExclusao() {
                const deleteButtons = document.querySelectorAll('.btn-delete');
                deleteButtons.forEach(button => {
                    button.addEventListener('click', async function() {
                        const userId = this.getAttribute('data-id');
                        const userRow = this.closest('tr');
                        const userName = userRow.cells[0].textContent;

                        if (confirm(`Tem certeza que deseja excluir o usuário "${userName}"?`)) {
                            spinner.style.display = 'flex';
                            try {
                                const response = await fetch(`${backendUrl}/usuarios/${userId}`, {
                                    method: 'DELETE'
                                });

                                const result = await response.json();

                                if (!response.ok) {
                                    throw new Error(result.mensagem || 'Erro desconhecido');
                                }
                                
                                alert(result.mensagem);
                                userRow.remove();

                            } catch (error) {
                                console.error('Erro ao excluir usuário:', error);
                                alert('Erro ao excluir usuário: ' + error.message);
                            } finally {
                                spinner.style.display = 'none';
                            }
                        }
                    });
                });
            }

            carregarUsuarios();
        });
    </script>
</body>
</html>